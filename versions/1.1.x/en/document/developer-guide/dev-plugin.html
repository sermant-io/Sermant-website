<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Plugin Development Guide | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/versions/1.1.x/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh Solution Based on JavaAgent">
    
    <link rel="preload" href="/versions/1.1.x/assets/css/0.styles.137be895.css" as="style"><link rel="preload" href="/versions/1.1.x/assets/js/app.15a6614f.js" as="script"><link rel="preload" href="/versions/1.1.x/assets/js/3.2e41a223.js" as="script"><link rel="preload" href="/versions/1.1.x/assets/js/1.b15421ba.js" as="script"><link rel="preload" href="/versions/1.1.x/assets/js/26.774c7952.js" as="script"><link rel="prefetch" href="/versions/1.1.x/assets/js/10.c6937ed1.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/100.29aab2ad.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/11.60305907.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/12.34d38cf9.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/13.1151c114.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/14.4b6dbdeb.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/15.e73a6d7c.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/16.fec41699.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/17.8c863cad.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/18.0eeef45d.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/19.c4a6998b.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/20.dbfa954d.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/21.7c12f239.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/22.7e7553bf.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/23.4b945458.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/24.a28f77d4.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/25.3342b84e.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/27.d4824132.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/28.58716e75.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/29.4bc3a581.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/30.27aa9a35.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/31.9486d5ff.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/32.8f6c8568.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/33.4f70e273.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/34.3f95c680.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/35.9ec9195c.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/36.b45bf902.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/37.963b608b.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/38.0b5dce9a.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/39.0a934ab1.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/4.e3cce00f.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/40.abd9432d.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/41.89296381.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/42.1b9f1efd.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/43.f1405586.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/44.8e803ce1.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/45.b36a2fd1.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/46.8cd93187.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/47.6cc50fcd.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/48.5330f67c.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/49.44e1f09f.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/5.1513b1e3.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/50.52c18ca2.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/51.14b876c8.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/52.cc9d697b.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/53.9a3fb42e.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/54.42ed566e.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/55.2a2788c2.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/56.061075fe.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/57.bffafae3.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/58.7108e6c0.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/59.a6b2ab12.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/6.564e5073.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/60.dac4d584.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/61.50a89b1a.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/62.2b8d2283.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/63.2095959d.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/64.5c02ceff.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/65.05253d57.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/66.7b7471ad.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/67.8eae4349.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/68.0622ee35.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/69.cc133ab0.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/7.c34496d9.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/70.3673cc2d.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/71.f80e5f7a.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/72.410e3f7f.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/73.471e9686.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/74.db59e196.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/75.60812559.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/76.a34f9101.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/77.ef25f076.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/78.aca3f97a.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/79.e3e5b119.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/8.2c82eb99.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/80.376f2911.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/81.9eee5fdf.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/82.181a6bb0.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/83.b1c469ee.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/84.d16beeda.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/85.99b71fc5.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/86.fc9badb9.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/87.e12c7f32.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/88.85be9e01.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/89.18fcf447.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/9.e914bb1e.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/90.133935f8.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/91.e12cc6d0.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/92.577be219.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/93.7c7a29ae.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/94.52a36cc9.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/95.3e1103fa.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/96.c71bbf11.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/97.ac991fd4.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/98.fe9ff1d1.js"><link rel="prefetch" href="/versions/1.1.x/assets/js/99.d77a5e29.js">
    <link rel="stylesheet" href="/versions/1.1.x/assets/css/0.styles.137be895.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/versions/1.1.x/en/" class="home-link router-link-active"><img src="/versions/1.1.x/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/versions/1.1.x/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/versions/1.1.x/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/versions/1.1.x/zh/document/developer-guide/dev-plugin.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/versions/1.1.x/en/document/developer-guide/dev-plugin.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/versions/1.1.x/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/versions/1.1.x/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/versions/1.1.x/zh/document/developer-guide/dev-plugin.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/versions/1.1.x/en/document/developer-guide/dev-plugin.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Start</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/versions/1.1.x/en/document/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/versions/1.1.x/en/document/QuickStart.html" class="sidebar-link">Quick Start</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>User Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Plugin Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developer Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="plugin-development-guide"><a href="#plugin-development-guide" class="header-anchor">#</a> Plugin Development Guide</h1> <p>This document focuses on <strong>Sermant</strong>'s <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template" target="_blank" rel="noopener noreferrer">example module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which describes some common scenarios during plug-in development.</p> <ul><li><a href="#Development-Environment">Development Environment</a></li> <li><a href="#Components">Components</a></li> <li><a href="#Plugin-Module">Plugin Module</a> <ul><li><a href="#Enhancement-Definition">Enhancement Definition</a> <ul><li><a href="#Enhancement-for-Native-Class">Enhancement for Native Class</a></li></ul></li> <li><a href="#Interceptor">Interceptor</a></li> <li><a href="#Plugin-Configuration">Plugin Configuration</a></li> <li><a href="#Plugin-Service">Plugin Service</a> <ul><li><a href="#Simple-Plugin-Service">Simple Plugin Service</a></li> <li><a href="#Complex-Plugin-Service">Complex Plugin Service</a></li> <li><a href="#Log">Log</a></li> <li><a href="#Heartbeat">Heartbeat</a></li> <li><a href="#Trace-Tracking">Trace Tracking</a></li> <li><a href="#Dynamic-Configuration">Dynamic Configuration</a></li></ul></li></ul></li> <li><a href="#Plugin-Service-Module">Plugin Service Module</a></li></ul> <h2 id="development-environment"><a href="#development-environment" class="header-anchor">#</a> Development Environment</h2> <ul><li><a href="https://gitee.com/openeuler/bishengjdk-8" target="_blank" rel="noopener noreferrer">HuaweiJDK 1.8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://github.com/openjdk/jdk" target="_blank" rel="noopener noreferrer">OpenJDK 1.8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> / <a href="https://www.oracle.com/java/technologies/downloads/" target="_blank" rel="noopener noreferrer">OracleJDK 1.8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener noreferrer">Apache Maven 3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="components"><a href="#components" class="header-anchor">#</a> Components</h2> <p>According to the <a href="/versions/1.1.x/en/document/UserGuide/plugin.html">Plugin Module</a>, a <code>main</code> plugin module contains the following five things:</p> <ul><li>The <code>plugin</code> module, which is mainly used to declare enhancements to the host application.</li> <li>The <code>service</code> module, which provides the service implementation for the plugin package.</li> <li>The <code>backend</code> module (server), which receives the data from plugin.</li> <li>The <code>frontend</code> module (webapp), which is used to display the server-side data</li> <li>The <code>other</code> module (special add-on), which is usually used for debugging.</li></ul> <p>Considering that the latter three have great changes with the actual business scenarios, they are given a high degree of development freedom, and they are only limited by the module directory and the output directory. For this reason, the <code>example module</code> will not be a reference case for them. The <code>example module</code> contains the following modules:</p> <ul><li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin" target="_blank" rel="noopener noreferrer">demo-plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: the example for plugin</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-service" target="_blank" rel="noopener noreferrer">demo-service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: the example for plugin service</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/demo-application" target="_blank" rel="noopener noreferrer">demo-application<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: the example for host application</li></ul> <h2 id="plugin-module"><a href="#plugin-module" class="header-anchor">#</a> Plugin Module</h2> <p>The example plugin module <code>demo-plugin</code> is mainly used to show plugin developers some scenarios that may be encountered in the development process of plugins and some functions that may be used.</p> <p>Before we start, it's important to agree that in <code>plugin</code> modules, developers can only use the <em>Java</em> native API and the <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and cannot rely on or use any third-party dependencies other than <code>byte-buddy</code> and <code>slf4j</code>. If the business needs to use other third-party dependencies, you can only define the interface in the <code>plugin</code> module and write the implementation in the <code>service</code> module. Refer to the <a href="/versions/1.1.x/en/document/UserGuide/plugin.html#Add-Plugin-Module">Plugin Module</a> for more information.</p> <h3 id="enhancement-definition"><a href="#enhancement-definition" class="header-anchor">#</a> Enhancement Definition</h3> <p>The core capability of <strong>Sermant</strong> is to make non-intrusive bytecode enhancements to the host application, and these enhancement rules are base on plugins. In the <code>main</code> module of each <strong>Sermant</strong> plugin, enhancement definitions can be defined to enhance the bytecode of specific methods of the host application to achieve certain functionality. So how the <code>main</code> module tells the <strong>Sermant</strong> which classes to augment is an important topic.</p> <p>The Enhancement definition of plugins requires the implementation of <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/declarer/PluginDeclarer.java" target="_blank" rel="noopener noreferrer">PluginDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> interface, which contains two methods:</p> <ul><li><code>getClassMatcher</code> is used to get the matcher <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassMatcher.java" target="_blank" rel="noopener noreferrer">ClassMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of the enhanced class.</li> <li><code>getInterceptDeclarers</code> is used to obtain the method of interceptor point of the enhanced class, as well as the interceptors embedded in it, encapsulated in the method interceptor point <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/declarer/InterceptDeclarer.java" target="_blank" rel="noopener noreferrer">InterceptDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><code>getSuperTpeDecarers</code> gets the plugin's superclass declaration <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/declarer/SuperTypeDeclarer.java" target="_blank" rel="noopener noreferrer">SuperTypeDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <p>The matcher <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassMatcher.java" target="_blank" rel="noopener noreferrer">ClassMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which provides two types of matchers in the core module:</p> <p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassTypeMatcher.java" target="_blank" rel="noopener noreferrer">ClassTypeMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(the matcher for class name)</p> <ul><li><p>The most common way to do this is purely by name matching, which is obtained by:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${class reference}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${class reference}</code> is the full qualified class name of the enhanced class.</p></li> <li><p>Matching multiple classes by name, which is the plural version of <code>nameEquals</code>, can be obtained with the following method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">&quot;${class reference array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${class reference array}</code> is a full qualified class name mutable array of the enhanced class.</p></li></ul> <p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/ClassFuzzyMatcher.java" target="_blank" rel="noopener noreferrer">ClassFuzzyMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（the fuzzy matcher of class name）</p> <ul><li><p>The enhanced class is located by the prefix of full qualified class name, which can be obtained by:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">namePrefixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${prefix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${prefix}</code> is the prefix of full qualified class name.</p></li> <li><p>The enhanced class is located by the suffix of full qualified class name, which can be retrieved as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameSuffixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${suffix}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${suffix}</code> is the suffix of full qualified class name.</p></li> <li><p>The enhanced class is located by the infix of full qualified class name, which can be obtained as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameinfixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${infix}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${infix}</code> is the infix of full qualified class name.</p></li> <li><p>The enhanced class is located by matching the full qualified class name with a regular expression, which can be obtained as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">nameMatches</span><span class="token punctuation">(</span><span class="token string">&quot;${pattern}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${pattern}</code> is a regular expression.</p></li> <li><p>The enhanced class is located by annotation decorated, which can be obtained as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">isAnnotationWith</span><span class="token punctuation">(</span><span class="token string">&quot;${annotation reference array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${annotation reference array}</code> is a full qualified class name array of annotations.</p></li> <li><p>Locating a subclass by means of a superclass can be obtained using the following methods:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">isExtendedFrom</span><span class="token punctuation">(</span><span class="token string">&quot;${super class array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${super class array}</code> is a superclass mutable array. Due to Java inheritance rules, the array can only have one <code>class</code>, the rest must be <code>interface</code>.</p></li> <li><p>A matching logical operation, which is true when all matchers do not match:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${class matcher array}</code> is a variable-length array of matcher.</p></li> <li><p>A matching logical operation, which is true if the matcher matches all of them:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${class matcher array}</code> is a variable-length array of matcher.</p></li> <li><p>A matching logical operation, which is true if one of the matcher matches:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClassMatcher</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;${class matcher array}&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Where <code>${class matcher array}</code> is a variable-length array of matcher.</p></li></ul> <p>For method interception points <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/matcher/MethodMatcher.java" target="_blank" rel="noopener noreferrer">MethodMatcher<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, we provide a variety of matching methods:</p> <ul><li><p>Match any method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Match by method name:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${method name}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name}</code> is the method name.</p></li> <li><p>Match static method:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Match constructor:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Match multiple methods:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">&quot;${method name array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name array}</code> is an array of method names.</p></li> <li><p>Match by prefix of method name:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">namePrefixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name prefix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name prefix}</code> is the prefix of method name .</p></li> <li><p>Match by suffix of method name:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameSuffixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name suffix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name suffix}</code> is the suffix of method name.</p></li> <li><p>Match by infix of method name：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameinfixedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${method name infix}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${method name infix}</code> is the infix of method name.</p></li> <li><p>Match by regular expression:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">nameMatches</span><span class="token punctuation">(</span><span class="token string">&quot;${pattern}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${pattern}</code> is a regular expression.</p></li> <li><p>Matches by annotation:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">isAnnotatedWith</span><span class="token punctuation">(</span><span class="token string">&quot;${annotations array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${annotations array}</code> is the annotation set.</p></li> <li><p>Match by specified number of arguments:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">paramCountEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${param count}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${param count}</code> is the number of input parameters.</p></li> <li><p>Match by the specific type of argument:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">paramTypeEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${param type array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${param type array}</code> is the set of input types.</p></li> <li><p>Match by return type</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">resultTypeEquals</span><span class="token punctuation">(</span><span class="token string">&quot;${result type}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${result type}</code> is the return type.</p></li> <li><p>Logical operation, where the result is true if the method matcher set does not match at all.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${element matcher array}</code> is the set of method matcher.</p></li> <li><p>Logical operation, where the result is true if the method matcher set fully matches.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${element matcher array}</code> is the set of method matcher.</p></li> <li><p>Logical operation, where the result is true if method matcher set matches one of the result.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;${element matcher array}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Where <code>${element matcher array}</code> is the set of method matcher.</p></li></ul> <p>For more methods matching method, refer to <a href="https://javadoc.io/doc/net.bytebuddy/byte-buddy/latest/net/bytebuddy/matcher/ElementMatchers.html" target="_blank" rel="noopener noreferrer">byte-buddy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> methods with a generic type of <code>MethodDescription</code> .</p> <p>Don't forget to add the <em>SPI</em> configuration file for the <code>PluginDeclarer</code> interface:</p> <ul><li>Add <code>META-INF/services</code> folder under <code>resources</code>.</li> <li>Add <code>com.huaweicloud.sermant.core.plugin.agent.declarer.PluginDeclarer</code> under <code>META-INF/services</code> .</li> <li>In the above file, type all the enhancements definitions of <code>PluginDeclarer</code> in the plugin package separated with LF.</li></ul> <p>The <code>example module</code> of <strong>Sermant</strong> contains the following example implementation of the <code>PluginDeclarer</code> interface:</p> <ul><li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/declarer/DemoAnnotationDeclarer.java" target="_blank" rel="noopener noreferrer">DemoAnnotationDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Locate enhanced class by annotation in the decorated class.</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/declarer/DemoNameDeclarer.java" target="_blank" rel="noopener noreferrer">DemoNameDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Locate enhanced class by name.</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/declarer/DemoSuperTypeDeclarer.java" target="_blank" rel="noopener noreferrer">DemoSuperTypeDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Locate enhanced class by superclass.</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/declarer/DemoBootstrapDeclarer.java" target="_blank" rel="noopener noreferrer">DemoBootstrapDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Enhancement definition for the boot classloader, refer to <a href="#Enhancement-for-Native-Class">Enhancement for Native Class</a> for details.</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/declarer/DemoTraceDeclarer.java" target="_blank" rel="noopener noreferrer">DemoTraceDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Enhancement definition for the usage of trace tracking, refer to <a href="#Trace-Tracking">Trace Tracking</a> for details.</li></ul> <p>When the plugin developers write the plugin enhancement definition, you can use the above examples as a reference to develop the enhancement definition that meets their own needs.</p> <h4 id="enhancement-for-native-class"><a href="#enhancement-for-native-class" class="header-anchor">#</a> Enhancement for Native Class</h4> <p>For <em>Java</em> native classes such as <code>java.lang.Thread</code>, which are loaded by the <code>BootStrapClassLoader</code>, there are two main difficulties in enhancing them:</p> <ul><li><p>Native classes are loaded by the BootStrapClassLoader, so if we want to enhance them, we need to overwrite the enhanced bytecode back into the BootStrapClassLoader. Considering that the enhanced embedded code is mostly written in <strong>interceptors</strong>, this content is mainly loaded by the system class loader <code>AppClassLoader</code>, which is not accessible by BootStrapClassLoader. Since <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/template" target="_blank" rel="noopener noreferrer"><strong>Advice template class</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> invokes the interceptors by reflection, it is allowed to write interceptors without restrictions for enhancement of native classes.</p></li> <li><p>Due to <em>Java</em> redefining <em>Class</em> restrictions, we can't modify the metadata of these native classes, so we can't use byte-buddy delegation to enhance them (by adding delegation properties and static code blocks). Fortunately, we can use <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/template" target="_blank" rel="noopener noreferrer"><strong>Advice template class</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> with <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/transformer/BootstrapTransformer.java" target="_blank" rel="noopener noreferrer"><strong>byte-buddy advice</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> technology to enhance. That's what <strong>core module</strong> is doing.</p></li></ul> <p>Combined with the above, there is no difference between native classes and regular classes in terms of enhancement definition and writing interceptors. However, it is desirable for plugin developers to minimize enhancement to native classes for three reasons:</p> <ul><li>Enhancements to native classes tend to be divergent. And enhancements to them are likely to impact other plugins or host functionality.</li> <li>The native class enhancement logic will use reflection to invoke interceptor methods in the system classloader. Due to the <em>Java</em> redefinition of the <em>Class</em>, every time an enhanced method is called, the reflection logic is processed, which significantly limits the <em>TPS</em> of the method.</li> <li>The enhancements to the native classes involved using the <strong>Advice template class</strong> to generate a dynamic interceptor class. For each enhanced native class method, one will be generated dynamically and they will be loaded by the system classloader. If native classes are enhanced without restriction, loading dynamic classes can also become a significant burden during startup.</li></ul> <p>In summary, <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> provides the ability to augment <em>Java</em> native classes. However, it is not recommended to enhance them without restrictions. If there are multiple enhancement points to choose from, you'd better choose enhancing regular classes.</p> <p>In <strong>Sermant</strong> <code>example module</code>, <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/declarer/DemoBootstrapDeclarer.java" target="_blank" rel="noopener noreferrer">DemoBootstrapDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> enhances <code>java.lang.Thread</code>. You can launch the example application <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/demo-application/src/main/java/com/huawei/example/demo/DemoApplication.java" target="_blank" rel="noopener noreferrer">DemoApplication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to see if <code>java.lang.Thread</code> is enhanced properly.</p> <h3 id="interceptor"><a href="#interceptor" class="header-anchor">#</a> Interceptor</h3> <p>In the development of the new version of the plugin, the distinction between static methods, constructors and instance methods is no longer made at the interceptor level, which reduces the complexity of plugin development.
For <code>MethodInterceptPoint</code>, there are three acquisition types: static method, constructor, and instance method. There are also three types of interceptors:</p> <ul><li><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/agent/interceptor/Interceptor.java" target="_blank" rel="noopener noreferrer">interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: the interceptor interface, which contains three methods:
<ul><li><code>before</code>, the preceding method, which is executed before the interception point. The ExecuteContext parameter is the context of the plugin execution, which encapsulates all the parameters required for the interceptor to operate. Through the skip method, the main process can be skipped and the final method result can be set. Note that the main process cannot be skipped when the constructor is enhanced .</li> <li><code>after</code>, the post-method, ends up in the post-method whether or not the intercepted method executes normally. Postmethods can override the return value of the intercepted method with their return value, so developers need to be careful not to return null easily here.</li> <li><code>onThrow</code>, an exception handling method that is triggered when the intercepted method executes an exception. Handling the exception here does not affect the normal throwing of the exception.</li></ul></li></ul> <p>The <code>example module</code> of <strong>Sermant</strong> contains the following example interceptor:</p> <ul><li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoStaticInterceptor.java" target="_blank" rel="noopener noreferrer">DemoStaticInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: an ordinary static method interceptor</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoConstInterceptor.java" target="_blank" rel="noopener noreferrer">DemoConstInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: an ordinary constructor interceptor</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoMemberInterceptor.java" target="_blank" rel="noopener noreferrer">DemoMemberInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: an ordinary instance method interceptor</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoConfigInterceptor.java" target="_blank" rel="noopener noreferrer">DemoConfigInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: an example interceptor for the plugin configuration acquisition, as described in the <a href="#Plugin-Configuration">Plugin Configuration</a> section.</li> <li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoServiceInterceptor.java" target="_blank" rel="noopener noreferrer">DemoServiceInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: an example interceptor for the usage of plugin service, as described in the <a href="#Plugin-Service">Plugin Service</a> section.</li></ul> <p>When writing custom interceptors, plugin developers can use the above example as a reference to develop interceptors that meet their own functional needs.</p> <h3 id="plugin-configuration"><a href="#plugin-configuration" class="header-anchor">#</a> Plugin Configuration</h3> <p><strong>Plugin Configuration</strong> refers to the configuration system used in plugin packages and plugin service packages. It consists of three main parts:</p> <ul><li><p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/config/PluginConfig.java" target="_blank" rel="noopener noreferrer">PluginConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> plugin configuration interface: All normal plugin configurations must implement this interface.</p></li> <li><p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/config/PluginConfigManager.java" target="_blank" rel="noopener noreferrer">PluginConfigManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> plugin configuration manager: provides a method to get the plugin configuration <code>PluginConfig</code> :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${plugin config class} is the plugin configuration class</span>
<span class="token class-name">PluginConfigManager</span><span class="token punctuation">.</span><span class="token function">getPluginConfig</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>plugin config <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>PluginConfigManager</code> is the unified configuration manager <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/ConfigManager.java" target="_blank" rel="noopener noreferrer">ConfigManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, The plugin side can directly use the interface of the latter to obtain plugin configuration and unified configuration：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${base config class}is the plugin configuration class or unified configuration class</span>
<span class="token class-name">ConfigManager</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>base config <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <p>From the <strong>Sermant</strong> <code>example module</code> plugin configuration file <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/config/config.yaml" target="_blank" rel="noopener noreferrer">config.yaml<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> can be seen that the configuration file is a <em>yaml file</em>. The <code>plugin</code> and <code>service</code> configurations of a <code>main</code> plugin module are encapsulated in a single <code>config.yaml</code>.</p> <p>Instead of a traditional <em>YAML</em> format configuration file for a single <em>Java Pojo</em> object, here <code>config.yaml</code> can encapsulate multiple <em>Java Pojos</em>, which are distinguished by fully qualified names or aliases, forming a <em>Map-like</em> structure. The key <code>demo.test</code> corresponds to the <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object in the <strong>example plugin package</strong> and <code>com.huawei.example.demo.config.DemoServiceConfig</code> key corresponds to <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-service/src/main/java/com/huawei/example/demo/config/DemoServiceConfig.java" target="_blank" rel="noopener noreferrer">DemoServiceConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object in the <strong>example plugin service pack</strong>.</p> <p>Compared to <code>DemoServiceConfig</code>, <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is decorated with the <a href="../../sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/common/ConfigTypeKey.java">ConfigTypeKey</a> annotation, so the <code>demo.test</code> alias is set. If it is not annotated with the <code>ConfigTypeKey</code> annotation, the full qualified class name is used as the index.</p> <p>The <code>map</code> property in <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is annotated with <a href="../../sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/common/ConfigFieldKey.java">ConfigFieldKey</a>, changing its property name to <code>str2DemoSimplePojoMap</code>. However, it is important to note that the semantics of the <strong>Java Pojo</strong> using this annotation is invalid if it is wrapped by an array, a <em>List</em> or a <em>Map</em>. Therefore, for now, this annotation can only be used to modify the current <strong>plugin configuration class</strong> or directly used <strong>Java Pojo</strong>.</p> <p>As <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> shows, plugin configuration now supports data types include:</p> <ul><li>Primitive and wrapper types for Boolean and numeric classes</li> <li>String</li> <li>Enum</li> <li>Complex object</li> <li>Array of the above types</li> <li>List of the first four types</li> <li>Map of the first four types</li></ul> <p><em>YAML</em> format configuration files currently have a few other rules:</p> <ul><li>For complex objects involved in arrays, lists, and maps, using <code>ConfigFieldKey</code> to fix property names is not supported.</li> <li>For strings in arrays, lists, and maps, there is no support for <code>${}</code> conversions, <strong>plugin configuration class</strong> string properties and string properties inside complex type properties are supported.</li> <li>Parameters are only used for string <code>${}</code> conversions. Direct setting property values using parameters is not supported.</li> <li>The field names of configuration classes are usually small camels.You can use <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/config/common/ConfigTypeKey.java" target="_blank" rel="noopener noreferrer">ConfigFieldKey<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to define aliases for the transverse-line style. After the annotation is added, it can be parsed in <em>YAML</em> using either transverse-line or small camel style. Refer to the <code>intField</code> of <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>The priority of the configuration is: startup parameters &gt; environment variables &gt; system variables (-d parameter) &gt; <em>YAML</em> file configuration</li> <li>The camel style and transverse line can be used to split words to look for matches when the configuration class properties fetch reference values according to the priority(startup parameters, environment variables, and system variables (-d parameter)) in effect. For example, for <code>intField</code> of <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the key will be transformed into one of the following forms and searched in order:
<ul><li>demo.test.intField</li> <li>demo_test_intField</li> <li>demo-test-intField</li> <li>DEMO.TEST.INTFIELD</li> <li>DEMO_TEST_INTFIELD</li> <li>DEMO-TEST-INTFIELD</li> <li>demo.test.intfield</li> <li>demo_test_intfield</li> <li>demo-test-intfield</li> <li>demo.test.int.field</li> <li>demo_test_int_field</li> <li>demo-test-int-field</li> <li>DEMO.TEST.INT.FIELD</li> <li>DEMO_TEST_INT_FIELD</li> <li>DEMO-TEST-INT-FIELD</li></ul></li> <li>If the key of the basic data type/array /map/list/set(which does not support complex objects) is not defined in the <em>YAML</em> configuration, the reference value will be obtained according to the priority of the configuration effect: startup parameters &gt; environment variables &gt; system variables (-d parameter). When retrieving reference values from the above data sources, note that:
<ul><li>The array /list/set should be configured in <code>YAML</code> string format. For example: DEMO_TEST_LIST_NAME=[elem1,elem2]</li> <li>The map needs to be configured as a <code>YAML</code> string format. For example: DEMO_TEST_MAP_NAME={key1: value1, key2: value2}</li></ul></li></ul> <p>Most of the possible configuration scenarios are covered in <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/config/DemoConfig.java" target="_blank" rel="noopener noreferrer">DemoConfig<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, plugin developers can reference and write plugin configuration classes that meet your business needs.</p> <p>Finally, don't forget to add the <em>SPI</em> configuration file for the plugin configuration:</p> <ul><li>Add <code>META-INF/services</code> folder under <code>resources</code>.</li> <li>Add <code>com.huaweicloud.sermant.core.plugin.config.PluginConfig</code> configuration file under <code>META-INF/services</code>.</li> <li>In the above file, type the <code>PluginConfig</code> implementation for all plugin configurations in the plugin package and separate them by LF.</li></ul> <h3 id="plugin-service"><a href="#plugin-service" class="header-anchor">#</a> Plugin Service</h3> <p><strong>Plugin service</strong> refers to the service system used in plugin package and plugin service package. It mainly consists of two parts:</p> <ul><li><p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/service/PluginService.java" target="_blank" rel="noopener noreferrer">PluginService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the plugin service interface.</p></li> <li><p><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/service/PluginServiceManager.java" target="_blank" rel="noopener noreferrer">PluginServiceManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the plugin service manager, which provides an interface to get <code>PluginService</code> :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${plugin service class} is the plugin service class</span>
<span class="token class-name">PluginServiceManager</span><span class="token punctuation">.</span><span class="token function">getPluginService</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>plugin service <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>PluginServiceManager</code> is a particular case of <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/service/ServiceManager.java" target="_blank" rel="noopener noreferrer">ServiceManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The latter interface can be used directly to access the core and plugin services:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${base service class}is the core service class or plugin service class</span>
<span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>base service <span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Learned form <a href="/versions/1.1.x/en/document/UserGuide/plugin.html#Add-Plugin-Module">Plugin Module</a>, plugins can be categorized as <strong>simple plugins</strong> and <strong>complex plugins</strong>, depending on the complexity of the service they define:</p> <ul><li>Services defined in <strong>simple plugins</strong> can only use <em>Java</em> native <em>APIs</em>, self-developed <em>APIs</em> (start with <code>com.huawei</code>) in <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> , and <em>APIs</em> of <code>byte-buddy</code> and <code>slf4j</code>.</li> <li>In addition to the above <em>API</em>, the services in <strong>complex plugins</strong> have the right to use other <em>APIs</em> that third parties rely on. These services need to be separated into the <strong>plugin service interface</strong> and the <strong>plugin service implementation</strong>: the former is written in the <code>plugin</code> module for the interceptor to invoke. The latter is written in the <code>service</code> module and loaded by a custom <em>ClassLoader</em> to achieve classloader-level dependency isolation.</li></ul></li></ul> <h4 id="simple-plugin-service"><a href="#simple-plugin-service" class="header-anchor">#</a> Simple Plugin Service</h4> <p>As for <strong>simple plugin service</strong>, you can just implement <a href="../../sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/service/PluginService.java">PluginService</a>, such as <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/service/DemoSimpleService.java" target="_blank" rel="noopener noreferrer">DemoSimpleService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Based on the implementation of the <code>start</code> and <code>stop</code> methods, you can add other required methods such as the <code>activeFunc</code> method. Get an instance of the <code>DemoSimpleService</code> and invoke the <code>activeFunc</code> method with the following code:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DemoSimpleService</span> simpleService <span class="token operator">=</span> <span class="token class-name">PluginServiceManager</span><span class="token punctuation">.</span><span class="token function">getPluginService</span><span class="token punctuation">(</span><span class="token class-name">DemoSimpleService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
simpleService<span class="token punctuation">.</span><span class="token function">activeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>For <strong>simple plugin service</strong>, the only restriction is to use only the <em>Java</em> native <em>API</em>, <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> self-developed <em>APIs</em> (starting with <code>com.huawei</code>) and <em>APIs</em> in <code>byte-buddy</code> and <code>slf4j</code>.</p> <p>Plugin developers can refer to <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/service/DemoSimpleService.java" target="_blank" rel="noopener noreferrer">DemoSimpleService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to write <strong>simple plugin services</strong> for your business on demand.</p> <p>Finally, don't forget to add the <em>SPI</em> configuration file for <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-agentcore/sermant-agentcore-core/src/main/java/com/huaweicloud/sermant/core/plugin/service/PluginService.java" target="_blank" rel="noopener noreferrer">PluginService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <ul><li>Add <code>META-INF/services</code> folder under <code>resources</code>.</li> <li>Add <code>com.huaweicloud.sermant.core.plugin.service.PluginService</code> configuration file under <code>META-INF/services</code>.</li> <li>In the above file, type the <code>PluginService</code> implementation for all plugin services in the plugin package and separate them by LF.</li></ul> <p>In particular, do not try to get instances of other <strong>plugin services</strong> in the <code>start</code> method of <code>PluginService</code>, since <strong>plugin services</strong> are still being initialized and it may not be possible to get these <strong>plugin services</strong> correctly.</p> <h4 id="complex-plugin-service"><a href="#complex-plugin-service" class="header-anchor">#</a> Complex Plugin Service</h4> <p>There are only two differences between <strong>complex plugin service</strong> and <strong>simple plugin service</strong>:</p> <ul><li><strong>Complex plugin services</strong> write their interface in the <code>plugin</code> module and their implementation in the <a href="#Plugin-Service-Module">Plugin Service Module</a>, while <strong>simple plugin services</strong> do not need to write the interface and are implemented directly in the <code>plugin</code> module.</li> <li>The implementation of a <strong>complex plugin service</strong> can use any third-party dependency on demand.</li></ul> <p><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/service/DemoComplexService.java" target="_blank" rel="noopener noreferrer">DemoComplexService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a <strong>complex plugin service</strong> sample interface. Methods can be added on demand, such as the <code>activeFunc</code> method. <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-service/src/main/java/com/huawei/example/demo/service/DemoComplexServiceImpl.java" target="_blank" rel="noopener noreferrer">DemoComplexServiceImpl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is the corresponding implementation. We can invoke the <code>activeFunc</code> method with the following code:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DemoComplexService</span> complexService <span class="token operator">=</span> <span class="token class-name">PluginServiceManager</span><span class="token punctuation">.</span><span class="token function">getPluginService</span><span class="token punctuation">(</span><span class="token class-name">DemoComplexService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
complexService<span class="token punctuation">.</span><span class="token function">activeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Adding <em>SPI</em> configuration and other considerations is no different than <strong>simple plugin service</strong>. Developers can refer the <code>DemoComplexService</code> interface and <code>DemoComplexServiceImpl</code> implementation to write <strong>complex plugin services</strong> that meet business requirements.</p> <h4 id="log"><a href="#log" class="header-anchor">#</a> Log</h4> <p>Considering dependency isolation, <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> provides the <code>plugin</code> and <code>service</code> to use only <strong>jul</strong> log. Get the <strong>jul</strong> log instance by:</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>huaweicloud<span class="token punctuation">.</span>sermant<span class="token punctuation">.</span>core<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>
<span class="token class-name">Logger</span> logger<span class="token operator">=</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Plugin developers who need to output log information can refer to <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/common/DemoLogger.java" target="_blank" rel="noopener noreferrer">DemoLogger<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sample development.</p> <h4 id="heartbeat"><a href="#heartbeat" class="header-anchor">#</a> Heartbeat</h4> <p>Heartbeat is one of the core services in <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. An instance of heartbeatService is obtained by:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">HeartbeatService</span> heartbeatService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">HeartbeatService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The heartbeat service starts execution when it is initialized, and periodically sends the name, version and other information of each plugin to the backend server. Currently, plugin heartbeats report information like:</p> <ul><li><code>hostname</code>: the hostname of the sending client</li> <li><code>ip</code>: the ip of the sending client</li> <li><code>app</code>: application name, as well as <code>appName</code> in startup parameters</li> <li><code>appType</code>: application type，as well as <code>appType</code> in startup parameters</li> <li><code>heartbeatVersion</code>: time of last heartbeat</li> <li><code>lastHeartbeat</code>: time of last heartbeat</li> <li><code>version</code>: the version of the core package, as well as the <code>sermant-version</code> value of the core package <code>manifest</code> file</li> <li><code>pluginName</code>: plugin name</li> <li><code>pluginVersion</code>：plugin version, which is the <code>Sermant-plugin-version</code> value of the <code>manifest</code> file in the plugin jar</li></ul> <p>If you want to add additional content to the data reported by the plugin, you can call the following API:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// use ExtInfoProvider to add additional content</span>
heartbeatService<span class="token punctuation">.</span><span class="token function">setExtInfo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExtInfoProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getExtInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Plugin developers who need to add additional content to the packets sent by the heartbeat function can refer to <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/service/DemoHeartBeatService.java" target="_blank" rel="noopener noreferrer">DemoHeartBeatService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sample development.</p> <p>For more information about heartbeat services, see <a href="/versions/1.1.x/en/document/developer-guide/service_heartbeat.html">Heartbeat Service</a>.</p> <h4 id="trace-tracking"><a href="#trace-tracking" class="header-anchor">#</a> Trace Tracking</h4> <p>The <strong>Trace Tracking</strong> is an upper layer function established by message sending capability, which simply means embedding the following logic between the invoke chains of the host side:</p> <ul><li>When sending data, the <code>TraceId</code> and <code>SpanId</code> required by the trace are inserted in the data packet. The former is the view of the whole trace in the distributed system, and the later represents the view inside the different services in the whole trace.</li> <li>When receiving data, it parses the trace-related content embedded in the data packet, forms a trace and submits it to the backend server, and gradually forms a invoke chain.</li></ul> <p>In the <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/demo-application/src/main/java/com/huawei/example/demo/service/DemoTraceService.java" target="_blank" rel="noopener noreferrer">DemoTraceService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the <code>counsumer</code> and <code>provider</code> methods mimic how the server receives data and handles sending it, while the packet is assumed to exist in a <code>ThreadLocal</code> until the next invocation to the <code>provider</code> method receives the data.</p> <p>Based on the above example host application, we write enhancement definition <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/declarer/DemoTraceDeclarer.java" target="_blank" rel="noopener noreferrer">DemoTraceDeclarer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and enhance <code>provider</code> and <code>consumer</code> of <code>DemoTraceService</code> by <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoTraceProviderInterceptor.java" target="_blank" rel="noopener noreferrer">DemoTraceProviderInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoTraceConsumerInterceptor.java" target="_blank" rel="noopener noreferrer">DemoTraceConsumerInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> respectively</p> <ul><li><p>For the sending <code>provider</code> method, the following enhancements are made：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TracingService</span> tracingService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">TracingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token class-name">TracingRequest</span> request <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">TracingRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getRawCls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">ExtractService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extractService <span class="token operator">=</span> <span class="token punctuation">(</span>tracingRequest<span class="token punctuation">,</span> carrier<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          tracingRequest<span class="token punctuation">.</span><span class="token function">setTraceId</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">TRACE_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          tracingRequest<span class="token punctuation">.</span><span class="token function">setParentSpanId</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">PARENT_SPAN_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          tracingRequest<span class="token punctuation">.</span><span class="token function">setSpanIdPrefix</span><span class="token punctuation">(</span>carrier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">SPAN_ID_PREFIX</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      tracingService<span class="token punctuation">.</span><span class="token function">onProviderSpanStart</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> extractService<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      tracingService<span class="token punctuation">.</span><span class="token function">onSpanFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">onThrow</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      tracingService<span class="token punctuation">.</span><span class="token function">onSpanError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>For the <code>consumer</code> method, the following enhancements are made：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token class-name">TracingService</span> tracingService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">TracingService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token class-name">TracingRequest</span> request <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">TracingRequest</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getRawCls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">InjectService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> injectService <span class="token operator">=</span> <span class="token punctuation">(</span>spanEvent<span class="token punctuation">,</span> carrier<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          carrier<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">TRACE_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanEvent<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          carrier<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">PARENT_SPAN_ID</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanEvent<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          carrier<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TracingHeader</span><span class="token punctuation">.</span><span class="token constant">SPAN_ID_PREFIX</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spanEvent<span class="token punctuation">.</span><span class="token function">getNextSpanIdPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      tracingService<span class="token punctuation">.</span><span class="token function">onConsumerSpanStart</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> injectService<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tracingService<span class="token punctuation">.</span><span class="token function">onSpanFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">ExecuteContext</span> <span class="token function">onThrow</span><span class="token punctuation">(</span><span class="token class-name">ExecuteContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      tracingService<span class="token punctuation">.</span><span class="token function">onSpanError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>If the plugin developers need to use the trace tracking function, refer to <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/interceptor/DemoTraceNormalInterceptor.java" target="_blank" rel="noopener noreferrer">DemoTraceNormalInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for further development.</p></li></ul> <h3 id="dynamic-configuration"><a href="#dynamic-configuration" class="header-anchor">#</a> Dynamic Configuration</h3> <p>Dynamic configuration is one of the core services in <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-agentcore/sermant-agentcore-core" target="_blank" rel="noopener noreferrer"><strong>Sermant</strong> core module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. An instance is obtained by:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DynamicConfigService</span> service <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">DynamicConfigService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Invoke the following method to register a listener:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ${group} is user group，${key} is the key listened. For zookeeper, the path is: / + ${group} + ${key}</span>
<span class="token comment">// if ${group} do not exist，it will set the value by dynamicconfig.default_group in unified configuration</span>
service<span class="token punctuation">.</span><span class="token function">addConfigListener</span><span class="token punctuation">(</span><span class="token string">&quot;${key}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;${group}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DynamicConfigListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">ConfigChangedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Once the listener is registered, the <code>process</code> method will be triggered when the server creates, deletes, modifies, or adds child nodes.</p> <p>Plugin developers who need to use dynamic configuration can refer to <a href="https://github.com/huaweicloud/Sermant-examples/tree/main/sermant-template/template/template-plugin/src/main/java/com/huawei/example/demo/service/DemoDynaConfService.java" target="_blank" rel="noopener noreferrer">DemoDynaConfService<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sample development.</p> <p>For more information on dynamic configuration service, refer to <a href="/versions/1.1.x/en/document/developer-guide/service_dynamicconfig.html">Dynamic Configuration Service</a>.</p> <h2 id="plugin-service-module"><a href="#plugin-service-module" class="header-anchor">#</a> Plugin Service Module</h2> <p>Compared to <strong>plugin module</strong>, <strong>plugin service module</strong> :</p> <ul><li>can only write a <strong>plugin configuration</strong> and <strong>plugin service interface</strong> implementation, and cannot write **enhancement definition ** <strong>interceptor</strong> and <strong>plugins service interface</strong>.</li> <li>allow the freedom to add third-party dependencies as needed. When packaging, you need to provide a way to export dependencies, you can use the <code>shade</code> plugin or <code>assembly</code> plugin to export the dependency <em>jar</em> package, or you can directly use the <code>dependency</code> plugin to export the dependency package.</li></ul> <p>Note: Due to the limitations of the <code>byte-buddy</code> and <code>slf4j</code> packages, it is still recommended to use the <code>shade</code> plugin package directly. The relevant rules are defined in the <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-plugins" target="_blank" rel="noopener noreferrer">main module of plugins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. You can directly import the plugin. Refer to <a href="/versions/1.1.x/en/document/UserGuide/plugin.html#Add-Plugin-Service-Module">Plugin Module</a> for details.</p> <p>The <strong>plugin service module</strong> usually involves writing <a href="#Plugin-Configuration">plugin configuration</a> and <a href="#Plugin-Service">plugin service</a>, where <strong>plugin service</strong> mainly refers to the implementation of <a href="#Complex-Plugin-Service">complex plugin service</a>.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/5/2024, 8:36:05 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/versions/1.1.x/assets/js/app.15a6614f.js" defer></script><script src="/versions/1.1.x/assets/js/3.2e41a223.js" defer></script><script src="/versions/1.1.x/assets/js/1.b15421ba.js" defer></script><script src="/versions/1.1.x/assets/js/26.774c7952.js" defer></script>
  </body>
</html>
