(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{540:function(a,t,e){"use strict";e.r(t);var s=e(26),r=Object(s.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"负载均衡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[a._v("#")]),a._v(" 负载均衡")]),a._v(" "),t("p",[a._v("本文介绍如何使用"),t("a",{attrs:{href:"https://github.com/huaweicloud/Sermant/tree/develop/sermant-plugins/sermant-loadbalancer",target:"_blank",rel:"noopener noreferrer"}},[a._v("负载均衡插件"),t("OutboundLink")],1),a._v("。")]),a._v(" "),t("h2",{attrs:{id:"功能介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#功能介绍"}},[a._v("#")]),a._v(" 功能介绍")]),a._v(" "),t("p",[a._v("负载均衡插件主要用于非侵入地动态修改宿主应用的负载均衡策略。")]),a._v(" "),t("h2",{attrs:{id:"参数配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参数配置"}},[a._v("#")]),a._v(" 参数配置")]),a._v(" "),t("h3",{attrs:{id:"插件配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#插件配置"}},[a._v("#")]),a._v(" 插件配置")]),a._v(" "),t("p",[a._v("负载均衡插件需要配置默认的负载均衡策略、是否强制使用插件的负载均衡等信息。可在"),t("code",[a._v("${path}/sermant-agent-x.x.x/agent/pluginPackage/loadbalancer/config/config.yaml")]),a._v("找到该插件的配置文件，配置如下所示：")]),a._v(" "),t("div",{staticClass:"language-yml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("loadbalancer.plugin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("defaultRule")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 默认的负载均衡策略。没有配置负载均衡策略时，使用默认的负载均衡策略。")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("forceUseSermantLb")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 是否强制使用插件的负载均衡。负载均衡插件通过该配置决定是否强制修改用户的负载均衡策略。当前配置仅对ribbon生效。ribbon可能存在用户自身的负载均衡配置, 若用户不想影响自身的负载均衡配置, 则可将之设置为false。")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("useCseRule")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 是否使用CSE规则。负载均衡插件根据是否使用CSE规则订阅不同的动态配置路径。")]),a._v("\n")])])]),t("table",[t("thead",[t("tr",[t("th",[a._v("参数键")]),a._v(" "),t("th",[a._v("说明")]),a._v(" "),t("th",[a._v("默认值")]),a._v(" "),t("th",[a._v("是否必须")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("loadbalancer.plugin.defaultRule")]),a._v(" "),t("td",[a._v("默认的负载均衡策略")]),a._v(" "),t("td",[a._v("空")]),a._v(" "),t("td",[a._v("否")])]),a._v(" "),t("tr",[t("td",[a._v("loadbalancer.plugin.forceUseSermantLb")]),a._v(" "),t("td",[a._v("是否强制使用插件的负载均衡")]),a._v(" "),t("td",[a._v("true")]),a._v(" "),t("td",[a._v("否")])]),a._v(" "),t("tr",[t("td",[a._v("loadbalancer.plugin.useCseRule")]),a._v(" "),t("td",[a._v("是否使用cse规则")]),a._v(" "),t("td",[a._v("true")]),a._v(" "),t("td",[a._v("否")])])])]),a._v(" "),t("h2",{attrs:{id:"详细治理规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#详细治理规则"}},[a._v("#")]),a._v(" 详细治理规则")]),a._v(" "),t("p",[a._v("负载均衡插件基于动态配置中心进行配置发布，配置发布可以参考"),t("RouterLink",{attrs:{to:"/zh/document/user-guide/configuration-center.html#发布配置"}},[a._v("动态配置中心使用手册")]),a._v("。")],1),a._v(" "),t("p",[a._v("负载均衡插件需要配置的动态配置信息如下:")]),a._v(" "),t("ul",[t("li",[a._v("servicecomb.matchGroup.xxx: 流量标记（动态配置的key值）。用于标记当前业务场景针对那些服务生效。其对应的content为")])]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("alias")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" loadbalancer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rule\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("matches")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("serviceName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" zk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("provider  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 目标服务名")]),a._v("\n")])])]),t("p",[t("code",[a._v("serviceName")]),a._v("为下游服务名，若配置项"),t("code",[a._v("serviceName")]),a._v("未配置，则应用于所有微服务。需要注意的是，该配置仅需配置"),t("code",[a._v("serviceName")]),a._v("配置项，其他的格式需保持不变。")]),a._v(" "),t("ul",[t("li",[a._v("servicecomb.loadbalance.xxx: 负载均衡规则（动态配置的key值）。用于配置具体业务场景下生效的负载均衡规则。其对应的content为")])]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("rule")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" Random\n")])])]),t("blockquote",[t("p",[a._v("说明： "),t("strong",[a._v("xxx为具体的业务场景名称， 流量标记和负载均衡策略的场景一致时负载均衡策略生效")]),a._v("。")])]),a._v(" "),t("p",[a._v("配置值的范围见表"),t("a",{attrs:{href:"#%E6%94%AF%E6%8C%81%E7%89%88%E6%9C%AC%E4%B8%8E%E9%99%90%E5%88%B6"}},[a._v("支持版本和限制")]),a._v("的"),t("strong",[a._v("配置值")]),a._v("。")]),a._v(" "),t("p",[a._v("负载均衡插件默认支持两种级别的group配置：")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("微服务级别：即group的值为"),t("code",[a._v("app=default&environment=&service=${yourServiceName}")]),a._v("，其中"),t("code",[a._v("${yourServiceName}")]),a._v("为动态获取的微服务名称，"),t("code",[a._v("environment")]),a._v("默认为空。可以参考"),t("RouterLink",{attrs:{to:"/zh/document/user-guide/sermant-agent.html#参数配置方式"}},[a._v("参数配置方式")]),a._v("对"),t("code",[a._v("app")]),a._v("与"),t("code",[a._v("envrionment")]),a._v("进行变更。")],1)]),a._v(" "),t("li",[t("p",[a._v("应用级别：即group的值为 "),t("code",[a._v("app=default&environment=")]),a._v(", "),t("code",[a._v("environment")]),a._v("默认为空, 环境变量配置方式同"),t("strong",[a._v("微服务级别")]),a._v("。")])])]),a._v(" "),t("h2",{attrs:{id:"支持版本与限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#支持版本与限制"}},[a._v("#")]),a._v(" 支持版本与限制")]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("框架类型")]),a._v(" "),t("th",[a._v("策略名")]),a._v(" "),t("th",[a._v("配置值 / 负载均衡策略")]),a._v(" "),t("th",[a._v("版本支持")])])]),a._v(" "),t("tbody",[t("tr",[t("td",[a._v("dubbo")]),a._v(" "),t("td",[a._v("随机（dubbo默认）")]),a._v(" "),t("td",[a._v("Random / RANDOM")]),a._v(" "),t("td",[a._v("2.6.x, 2.7.x")])]),a._v(" "),t("tr",[t("td",[a._v("dubbo")]),a._v(" "),t("td",[a._v("轮询")]),a._v(" "),t("td",[a._v("RoundRobin / ROUNDROBIN")]),a._v(" "),t("td",[a._v("2.6.x, 2.7.x")])]),a._v(" "),t("tr",[t("td",[a._v("dubbo")]),a._v(" "),t("td",[a._v("最少活跃")]),a._v(" "),t("td",[a._v("leastActive / LEASTACTIVE")]),a._v(" "),t("td",[a._v("2.6.x, 2.7.x")])]),a._v(" "),t("tr",[t("td",[a._v("dubbo")]),a._v(" "),t("td",[a._v("一致性HASH")]),a._v(" "),t("td",[a._v("consistentHash / CONSISTENTHASH")]),a._v(" "),t("td",[a._v("2.6.x, 2.7.x")])]),a._v(" "),t("tr",[t("td",[a._v("dubbo")]),a._v(" "),t("td",[a._v("最短响应时间")]),a._v(" "),t("td",[a._v("shortestResponse / SHORTESTRESPONSE")]),a._v(" "),t("td",[a._v("2.7.7+")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("区域权重（ribbon默认）")]),a._v(" "),t("td",[a._v("zoneAvoidance / ZONE_AVOIDANCE")]),a._v(" "),t("td",[a._v("ZONE_AVOIDANCEspring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("随机")]),a._v(" "),t("td",[a._v("Random / RANDOM")]),a._v(" "),t("td",[a._v("spring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("轮询")]),a._v(" "),t("td",[a._v("RoundRobin / ROUND_ROBIN")]),a._v(" "),t("td",[a._v("spring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("重试")]),a._v(" "),t("td",[a._v("retry / RETRY")]),a._v(" "),t("td",[a._v("spring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("最低并发")]),a._v(" "),t("td",[a._v("bestAvailable / BEST_AVAILABLE")]),a._v(" "),t("td",[a._v("spring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("筛选过滤轮询")]),a._v(" "),t("td",[a._v("availabilityFiltering / AVAILABILITY_FILTERING")]),a._v(" "),t("td",[a._v("spring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("响应时间加权重（Deprecated）")]),a._v(" "),t("td",[a._v("ResponseTimeWeighted / RESPONSE_TIME_WEIGHTED")]),a._v(" "),t("td",[a._v("spring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-netflix-ribbon")]),a._v(" "),t("td",[a._v("响应时间加权重")]),a._v(" "),t("td",[a._v("weightedResponseTime / WEIGHTED_RESPONSE_TIME")]),a._v(" "),t("td",[a._v("spring cloud Edgware.x, spring cloud Finchley.x, spring cloud Greenwich.x, spring cloud Hoxton.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-loadbalancer")]),a._v(" "),t("td",[a._v("轮询（loadbalancer默认）")]),a._v(" "),t("td",[a._v("RoundRobin / ROUND_ROBIN")]),a._v(" "),t("td",[a._v("spring cloud Hoxton.SR10+, spring cloud 2020.0.x, spring cloud 2021.0.x")])]),a._v(" "),t("tr",[t("td",[a._v("spring-cloud-loadbalancer")]),a._v(" "),t("td",[a._v("随机")]),a._v(" "),t("td",[a._v("Random / RANDOM")]),a._v(" "),t("td",[a._v("spring cloud Hoxton.SR10+, spring cloud 2020.0.x, spring cloud 2021.0.x")])])])]),a._v(" "),t("h2",{attrs:{id:"操作和结果验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#操作和结果验证"}},[a._v("#")]),a._v(" 操作和结果验证")]),a._v(" "),t("p",[a._v("下面将演示如何使用负载均衡插件，验证SpringBoot应用采用ZooKeeper配置中心，动态更新宿主应用的负载均衡策略场景。")]),a._v(" "),t("h3",{attrs:{id:"准备工作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[a._v("#")]),a._v(" 准备工作")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/huaweicloud/Sermant-examples/releases/download/v1.4.0/sermant-examples-load-balance-demo-1.4.0.tar.gz",target:"_blank",rel:"noopener noreferrer"}},[a._v("下载"),t("OutboundLink")],1),a._v(" Demo二进制产物压缩包")]),a._v(" "),t("li",[t("a",{attrs:{href:"https://github.com/huaweicloud/Sermant/releases/download/v1.4.0/sermant-1.4.0.tar.gz",target:"_blank",rel:"noopener noreferrer"}},[a._v("下载"),t("OutboundLink")],1),a._v(" Sermant\nRelease包（当前版本推荐1.4.0版本）")]),a._v(" "),t("li",[t("a",{attrs:{href:"https://zookeeper.apache.org/releases.html#download",target:"_blank",rel:"noopener noreferrer"}},[a._v("下载"),t("OutboundLink")],1),a._v("并启动ZooKeeper")])]),a._v(" "),t("h3",{attrs:{id:"步骤一-获取demo二进制产物"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#步骤一-获取demo二进制产物"}},[a._v("#")]),a._v(" 步骤一：获取Demo二进制产物")]),a._v(" "),t("p",[a._v("解压Demo二进制产物压缩包，即可得到"),t("code",[a._v("resttemplate-consumer.jar")]),a._v("和"),t("code",[a._v("resttemplate-provider.jar")]),a._v("。")]),a._v(" "),t("h3",{attrs:{id:"步骤二-发布流量标记"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#步骤二-发布流量标记"}},[a._v("#")]),a._v(" 步骤二：发布流量标记")]),a._v(" "),t("p",[a._v("参考使用"),t("RouterLink",{attrs:{to:"/zh/document/user-guide/configuration-center.html#发布配置"}},[a._v("动态配置中心使用手册")]),a._v("进行配置发布，发布如下配置")],1),a._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"content"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alias: loadbalancer-rule\\n matches:\\n- serviceName: zk-rest-provider"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"group"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"app=default&environment=&service=zk-rest-consumer"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"key"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"servicecomb.matchGroup.testLb"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),t("p",[a._v("以ZooKeeper为例，利用ZooKeeper提供的命令行工具进行配置发布。")]),a._v(" "),t("p",[a._v("1、在"),t("code",[a._v("${path}/bin/")]),a._v("目录执行以下命令创建节点"),t("code",[a._v("/app=default&environment=&service=zk-rest-consumer")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# linux mac")]),a._v("\n./zkCli.sh "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-server")]),a._v(" localhost:2181 create /app"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("service")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("zk-rest-consumer\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# windows")]),a._v("\nzkCli.cmd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-server")]),a._v(" localhost:2181 create /app"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("service")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("zk-rest-consumer\n")])])]),t("blockquote",[t("p",[a._v("说明："),t("code",[a._v("${path}")]),a._v("为zookeeper的安装目录")])]),a._v(" "),t("p",[a._v("2、在"),t("code",[a._v("${path}/bin/")]),a._v("目录执行以下命令创建节点"),t("code",[a._v("/app=default&environment=&service=zk-rest-consumer/servicecomb.matchGroup.testLb")]),a._v("和数据"),t("code",[a._v("alias: loadbalancer-rule\\n matches:\\n- serviceName: zk-rest-provider")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# linux mac")]),a._v("\n./zkCli.sh "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-server")]),a._v(" localhost:2181 create /app"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("service")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("zk-rest-consumer/servicecomb.matchGroup.testLb "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alias: loadbalancer-rule\nmatches:\n- serviceName: zk-rest-provider"')]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# windows")]),a._v("\nzkCli.cmd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-server")]),a._v(" localhost:2181 create /app"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("service")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("zk-rest-consumer/servicecomb.matchGroup.testLb "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alias: loadbalancer-rule\nmatches:\n- serviceName: zk-rest-provider"')]),a._v("\n")])])]),t("h3",{attrs:{id:"步骤三-发布匹配的负载均衡规则-以random为例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#步骤三-发布匹配的负载均衡规则-以random为例"}},[a._v("#")]),a._v(" 步骤三：发布匹配的负载均衡规则（以Random为例）")]),a._v(" "),t("p",[a._v("参考使用"),t("RouterLink",{attrs:{to:"/zh/document/user-guide/configuration-center.html#发布配置"}},[a._v("动态配置中心使用手册")]),a._v("进行配置发布， 发布如下配置")],1),a._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"content"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"rule: Random"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"group"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"app=default&environment=&service=zk-rest-consumer"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"key"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"servicecomb.loadbalance.testLb"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),t("p",[a._v("以ZooKeeper为例，利用ZooKeeper提供的命令行工具进行配置发布。")]),a._v(" "),t("p",[a._v("1、在"),t("code",[a._v("${path}/bin/")]),a._v("目录执行以下命令创建节点"),t("code",[a._v("/app=default&environment=&service=zk-rest-consumer/servicecomb.loadbalance.testLb")]),a._v("和数据"),t("code",[a._v("rule: Random")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# linux mac")]),a._v("\n./zkCli.sh "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-server")]),a._v(" localhost:2181 create /app"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("service")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("zk-rest-consumer/servicecomb.loadbalance.testLb "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"rule: Random"')]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# windows")]),a._v("\nzkCli.cmd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-server")]),a._v(" localhost:2181 create /app"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("environment")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("service")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("zk-rest-consumer/servicecomb.loadbalance.testLb "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"rule: Random"')]),a._v("\n")])])]),t("h3",{attrs:{id:"步骤四-启动demo应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#步骤四-启动demo应用"}},[a._v("#")]),a._v(" 步骤四：启动Demo应用")]),a._v(" "),t("p",[a._v("参考如下命令启动两个生产者")]),a._v(" "),t("ul",[t("li",[a._v("参考如下命令启动服务提供者，端口为8006")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Run under Linux")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" -javaagent:"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${path}")]),a._v("/sermant-agent-x.x.x/agent/sermant-agent.jar"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("appName"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Dserver.port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8006")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-jar")]),a._v(" resttemplate-provider.jar\n")])])]),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Run under Windows")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" -javaagent:"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${path}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("sermant-agent-x.x.x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("agent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("sermant-agent.jar"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("appName"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Dserver.port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8006")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-jar")]),a._v(" resttemplate-provider.jar\n")])])]),t("ul",[t("li",[a._v("参考如下命令启动服务提供者，端口为8007")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Run under Linux")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" -javaagent:"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${path}")]),a._v("/sermant-agent-x.x.x/agent/sermant-agent.jar"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("appName"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Dserver.port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8007")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-jar")]),a._v(" resttemplate-provider.jar\n")])])]),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Run under Windows")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" -javaagent:"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${path}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("sermant-agent-x.x.x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("agent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("sermant-agent.jar"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("appName"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Dserver.port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8007")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-jar")]),a._v(" resttemplate-provider.jar\n")])])]),t("ul",[t("li",[a._v("参考如下命令启动消费者（一个实例即可），端口为8005")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Run under Linux")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" -javaagent:"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${path}")]),a._v("/sermant-agent-x.x.x/agent/sermant-agent.jar"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("appName"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Dserver.port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8005")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-jar")]),a._v(" resttemplate-consumer.jar\n")])])]),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Run under Windows")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("java")]),a._v(" -javaagent:"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${path}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("sermant-agent-x.x.x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("agent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("sermant-agent.jar"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("appName"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("default "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Dserver.port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8005")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-jar")]),a._v(" resttemplate-consumer.jar\n")])])]),t("blockquote",[t("p",[t("strong",[a._v("说明：")]),a._v(" ${path}为sermant实际安装路径，x.x.x代表sermant某个版本号。")])]),a._v(" "),t("h3",{attrs:{id:"验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[a._v("#")]),a._v(" 验证")]),a._v(" "),t("p",[a._v("上面步骤全部完成后，访问接口 "),t("code",[a._v("http://localhost:8005/hello")]),a._v(", 多次调用，如果返回的端口信息中8006、8007随机展示则表示随机负载均衡规则（默认为轮询）已生效。")]),a._v(" "),t("p",[a._v("效果图如下所示：")]),a._v(" "),t("MyImage",{attrs:{src:"/docs-img/loadbanlance1.png"}}),a._v(" "),t("MyImage",{attrs:{src:"/docs-img/loadbanlance2.png"}})],1)}),[],!1,null,null,null);t.default=r.exports}}]);