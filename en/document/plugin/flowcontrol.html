<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flow Control | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh based on Bytecode Enhancement">
    
    <link rel="preload" href="/assets/css/0.styles.b3162cc2.css" as="style"><link rel="preload" href="/assets/js/app.113d7599.js" as="script"><link rel="preload" href="/assets/js/3.5623409f.js" as="script"><link rel="preload" href="/assets/js/1.b15421ba.js" as="script"><link rel="preload" href="/assets/js/50.e52baf42.js" as="script"><link rel="preload" href="/assets/js/15.e73a6d7c.js" as="script"><link rel="prefetch" href="/assets/js/10.cfbef995.js"><link rel="prefetch" href="/assets/js/100.35438c59.js"><link rel="prefetch" href="/assets/js/101.2a813f1e.js"><link rel="prefetch" href="/assets/js/102.a27d8e53.js"><link rel="prefetch" href="/assets/js/103.da72b75a.js"><link rel="prefetch" href="/assets/js/104.c54f6e75.js"><link rel="prefetch" href="/assets/js/105.dfa895a4.js"><link rel="prefetch" href="/assets/js/106.b5f106ea.js"><link rel="prefetch" href="/assets/js/107.f7c98a40.js"><link rel="prefetch" href="/assets/js/108.2d90bf2e.js"><link rel="prefetch" href="/assets/js/109.2150f151.js"><link rel="prefetch" href="/assets/js/11.60305907.js"><link rel="prefetch" href="/assets/js/110.8c6d75d8.js"><link rel="prefetch" href="/assets/js/111.092122a1.js"><link rel="prefetch" href="/assets/js/112.06bea806.js"><link rel="prefetch" href="/assets/js/113.81d1d9c5.js"><link rel="prefetch" href="/assets/js/114.cd06da03.js"><link rel="prefetch" href="/assets/js/12.34d38cf9.js"><link rel="prefetch" href="/assets/js/13.86a0f1e9.js"><link rel="prefetch" href="/assets/js/14.dec8b3a9.js"><link rel="prefetch" href="/assets/js/16.fec41699.js"><link rel="prefetch" href="/assets/js/17.23f850a3.js"><link rel="prefetch" href="/assets/js/18.f406bc1c.js"><link rel="prefetch" href="/assets/js/19.a75ad99f.js"><link rel="prefetch" href="/assets/js/20.b657f769.js"><link rel="prefetch" href="/assets/js/21.a73549a1.js"><link rel="prefetch" href="/assets/js/22.90975c19.js"><link rel="prefetch" href="/assets/js/23.97cb668f.js"><link rel="prefetch" href="/assets/js/24.c2865696.js"><link rel="prefetch" href="/assets/js/25.a3b85f1c.js"><link rel="prefetch" href="/assets/js/26.7cc45b1e.js"><link rel="prefetch" href="/assets/js/27.fe4c5dbb.js"><link rel="prefetch" href="/assets/js/28.44bd2b3f.js"><link rel="prefetch" href="/assets/js/29.ae3de011.js"><link rel="prefetch" href="/assets/js/30.5d179fd7.js"><link rel="prefetch" href="/assets/js/31.ca23d164.js"><link rel="prefetch" href="/assets/js/32.6493d78f.js"><link rel="prefetch" href="/assets/js/33.56d800c8.js"><link rel="prefetch" href="/assets/js/34.64e71f68.js"><link rel="prefetch" href="/assets/js/35.67da549b.js"><link rel="prefetch" href="/assets/js/36.9b951f23.js"><link rel="prefetch" href="/assets/js/37.1d6019dc.js"><link rel="prefetch" href="/assets/js/38.6f11668f.js"><link rel="prefetch" href="/assets/js/39.d8101f9f.js"><link rel="prefetch" href="/assets/js/4.1f7cf31c.js"><link rel="prefetch" href="/assets/js/40.930be54c.js"><link rel="prefetch" href="/assets/js/41.0daeaebd.js"><link rel="prefetch" href="/assets/js/42.d220a2de.js"><link rel="prefetch" href="/assets/js/43.6cfcf2bd.js"><link rel="prefetch" href="/assets/js/44.0325b97f.js"><link rel="prefetch" href="/assets/js/45.b51fea98.js"><link rel="prefetch" href="/assets/js/46.a6c0a5e2.js"><link rel="prefetch" href="/assets/js/47.4f0a114b.js"><link rel="prefetch" href="/assets/js/48.4c5f9644.js"><link rel="prefetch" href="/assets/js/49.0d4508d4.js"><link rel="prefetch" href="/assets/js/5.27b946c4.js"><link rel="prefetch" href="/assets/js/51.323b9617.js"><link rel="prefetch" href="/assets/js/52.346fa80a.js"><link rel="prefetch" href="/assets/js/53.9cfa5608.js"><link rel="prefetch" href="/assets/js/54.50aa7fc0.js"><link rel="prefetch" href="/assets/js/55.de87de68.js"><link rel="prefetch" href="/assets/js/56.b34fac6d.js"><link rel="prefetch" href="/assets/js/57.a0e4792b.js"><link rel="prefetch" href="/assets/js/58.3b83140b.js"><link rel="prefetch" href="/assets/js/59.255861a7.js"><link rel="prefetch" href="/assets/js/6.a6913bc1.js"><link rel="prefetch" href="/assets/js/60.f1229caf.js"><link rel="prefetch" href="/assets/js/61.ebbfb1ac.js"><link rel="prefetch" href="/assets/js/62.4125fce4.js"><link rel="prefetch" href="/assets/js/63.2f37913f.js"><link rel="prefetch" href="/assets/js/64.ba4db5b6.js"><link rel="prefetch" href="/assets/js/65.5917e76d.js"><link rel="prefetch" href="/assets/js/66.929b4eb4.js"><link rel="prefetch" href="/assets/js/67.349bf041.js"><link rel="prefetch" href="/assets/js/68.df035518.js"><link rel="prefetch" href="/assets/js/69.c8a901a7.js"><link rel="prefetch" href="/assets/js/7.d018164a.js"><link rel="prefetch" href="/assets/js/70.291db580.js"><link rel="prefetch" href="/assets/js/71.bcdac895.js"><link rel="prefetch" href="/assets/js/72.9490e30b.js"><link rel="prefetch" href="/assets/js/73.20e39769.js"><link rel="prefetch" href="/assets/js/74.cc2dec6d.js"><link rel="prefetch" href="/assets/js/75.83cc918a.js"><link rel="prefetch" href="/assets/js/76.74c0bda8.js"><link rel="prefetch" href="/assets/js/77.6073f5b0.js"><link rel="prefetch" href="/assets/js/78.6b7eb13a.js"><link rel="prefetch" href="/assets/js/79.5bd9087f.js"><link rel="prefetch" href="/assets/js/8.10750ce9.js"><link rel="prefetch" href="/assets/js/80.33d00ed7.js"><link rel="prefetch" href="/assets/js/81.d4686ffc.js"><link rel="prefetch" href="/assets/js/82.0e7954d1.js"><link rel="prefetch" href="/assets/js/83.351db1d0.js"><link rel="prefetch" href="/assets/js/84.0beeefe9.js"><link rel="prefetch" href="/assets/js/85.162b3960.js"><link rel="prefetch" href="/assets/js/86.233cebc6.js"><link rel="prefetch" href="/assets/js/87.9c771632.js"><link rel="prefetch" href="/assets/js/88.58ac31af.js"><link rel="prefetch" href="/assets/js/89.c2001884.js"><link rel="prefetch" href="/assets/js/9.4d2ce84a.js"><link rel="prefetch" href="/assets/js/90.9504d33c.js"><link rel="prefetch" href="/assets/js/91.3ec8bf56.js"><link rel="prefetch" href="/assets/js/92.5e53a064.js"><link rel="prefetch" href="/assets/js/93.66bb1a7e.js"><link rel="prefetch" href="/assets/js/94.34ece11b.js"><link rel="prefetch" href="/assets/js/95.3a1fe615.js"><link rel="prefetch" href="/assets/js/96.4335f27c.js"><link rel="prefetch" href="/assets/js/97.9a50a7bd.js"><link rel="prefetch" href="/assets/js/98.80a0d99b.js"><link rel="prefetch" href="/assets/js/99.c4afbd41.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b3162cc2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/en/" class="home-link router-link-active"><img src="/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/sermant-io/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/flowcontrol.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/flowcontrol.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/sermant-io/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/flowcontrol.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/flowcontrol.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>User Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Plugin Guide</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/en/document/plugin/" aria-current="page" class="sidebar-link">Plugin</a></li><li><a href="/en/document/plugin/dynamic-config.html" class="sidebar-link">Dynamic Configuration</a></li><li><a href="/en/document/plugin/springboot-registry.html" class="sidebar-link">SpringBoot Registry</a></li><li><a href="/en/document/plugin/register-migration.html" class="sidebar-link">Service Registry</a></li><li><a href="/en/document/plugin/flowcontrol.html" aria-current="page" class="active sidebar-link">Flow Control</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/en/document/plugin/flowcontrol.html#functions" class="sidebar-link">Functions</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/flowcontrol.html#parameter-configuration" class="sidebar-link">Parameter configuration</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/flowcontrol.html#detailed-governance-rules" class="sidebar-link">Detailed governance rules</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/flowcontrol.html#supported-versions-and-limitations" class="sidebar-link">Supported Versions and Limitations</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/flowcontrol.html#operation-and-result-validation" class="sidebar-link">Operation and result validation</a></li></ul></li><li><a href="/en/document/plugin/graceful.html" class="sidebar-link">Graceful Startup/Shutdown</a></li><li><a href="/en/document/plugin/removal.html" class="sidebar-link">Outlier instance removal</a></li><li><a href="/en/document/plugin/loadbalancer.html" class="sidebar-link">Load balancing</a></li><li><a href="/en/document/plugin/router.html" class="sidebar-link">Tag Router</a></li><li><a href="/en/document/plugin/monitor.html" class="sidebar-link">Monitoring</a></li><li><a href="/en/document/plugin/visibility.html" class="sidebar-link">Service visibility</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developer Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="flow-control"><a href="#flow-control" class="header-anchor">#</a> Flow Control</h1> <p>This article describes how to use <a href="https://github.com/sermant-io/Sermant/tree/develop/sermant-plugins/sermant-flowcontrol" target="_blank" rel="noopener noreferrer">Flow Control Plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="functions"><a href="#functions" class="header-anchor">#</a> Functions</h2> <p>The flow control plugin is based on the <a href="(https://github.com/resilience4j)">resilience4j</a> framework and implements non-intrusive flow control based on the &quot;traffic&quot; entry point. Currently, <strong>Traffic Limiting, Circuit Breaker, Bulkhead, Error Injection, Retry and Fusing index collection</strong> are supported. In addition, rules can be dynamically configured in the configuration center and take effect in real time.</p> <ul><li><strong>Traffic Limiting</strong>：The number of QPS that pass through a specified interface within 1s is limited. When the traffic within 1s exceeds the specified threshold, flow control is triggered to limit the requested traffic.</li> <li><strong>Circuit Breaker</strong>：Configure a circuit breaker policy for a specified interface to collect statistics on the error rate or slow request rate in a specified time window. When the error rate or slow request rate reaches a specified threshold, the circuit breaker is triggered. Before the time window is reset, all requests are isolated.</li> <li><strong>Bulkhead</strong>：Controls concurrent traffic for a large number of concurrent traffic to prevent service breakdown caused by excessive instantaneous concurrent traffic.</li> <li><strong>Retry</strong>：If a service encounters a non-fatal error, you can retry the service to prevent the service failure.</li> <li><strong>Error Injection</strong>：An error injection policy is configured for a specified service when the service is running. Before the client accesses the target service, the error injection policy is used. This policy is mainly used to reduce the access load of the target service and can be used as a measure of downgrading the target service.</li> <li><strong>Fusing index collection</strong>： During the service operation, collect the information related to the fuse, and report the indicators with the help of the <a href="/en/document/plugin/monitor.html">monitoring plugin</a></li> <li><strong>System Rule</strong>：When the instance is running, if the system load, CPU, number of threads, average response time, and any index of qps exceed the preset value, flow control will be triggered to limit the request flow.</li> <li><strong>System Adaptive</strong>：When the instance is running, the request is adaptively flow controlled according to the current load status of the system and the system data in the past period.</li></ul> <h2 id="parameter-configuration"><a href="#parameter-configuration" class="header-anchor">#</a> Parameter configuration</h2> <h3 id="configure-sermant-agent"><a href="#configure-sermant-agent" class="header-anchor">#</a> Configure Sermant-agent</h3> <p>To modify service information and dynamically configure the type and address of the center, refer to <a href="/en/document/user-guide/sermant-agent.html">Sermant-agent User Manual</a>.</p> <h3 id="configure-the-flow-control-plugin"><a href="#configure-the-flow-control-plugin" class="header-anchor">#</a> Configure the Flow Control Plugin</h3> <p>Modify the Configuration File<code>${javaagent path}/pluginPackage/flowcontrol/config/config.yaml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">flow.control.plugin</span><span class="token punctuation">:</span>
  <span class="token key atrule">useCseRule</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># Whether to enable ServiceComb adaptation</span>
  <span class="token key atrule">enable-start-monitor</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># Whether to start indicator monitoring</span>
  <span class="token key atrule">enable-system-adaptive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># Whether the system adaptive flow control is enabled. Enabling this switch requires that the enable-system-rule configuration item also be enabled</span>
  <span class="token key atrule">enable-system-rule</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># Whether to enable system rule flow control</span>
</code></pre></div><table><thead><tr><th>Key in Input Parameters</th> <th>Description</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>useCseRule</td> <td>If adaptation is enabled, the plugin subscribes to the configuration center based on the application configuration, service configuration, and customized tag configuration.If useCseRule is set to false, the flow control plugin configures subscription based on the service name of the current instance. For example, if spring.application.name is set to flowControlDemo, the flow control plugin receives configuration based on the service=flowControlDemo tag during actual subscription.</td> <td>true</td> <td>true</td></tr> <tr><td>enable-start-monitor</td> <td>Indicator monitoring switch</td> <td>false</td> <td>false</td></tr> <tr><td>enable-system-adaptive</td> <td>Whether to turn on the system adaptive flow control switch. To turn on this switch, the <strong>enable-system-rule</strong> configuration item should also be turned on, set to true, and after the corresponding flow control strategy is issued, adaptive flow control will be performed on the request flow according to the system load status</td> <td>false</td> <td>false</td></tr> <tr><td>enable-system-rule</td> <td>Whether to turn on the system rule flow control switch, set it to true and issue the corresponding flow control policy, then the request flow will be controlled according to the system parameter threshold set in the policy</td> <td>false</td> <td>false</td></tr></tbody></table> <h2 id="detailed-governance-rules"><a href="#detailed-governance-rules" class="header-anchor">#</a> Detailed governance rules</h2> <p>Traffic governance uses traffic marking and flow control rules to control specified traffic. Traffic marking refers to request information, such as the interface path, interface method type, request header, and downstream service name.</p> <p>Whether a flow control rule takes effect depends on the traffic flag. A flow control rule takes effect only when the traffic flag matches the request. The mapping between traffic marks and specific rules depends on the service scenario name. Generally, a specified prefix must be configured for traffic marks and traffic control rules.</p> <p>Prefixes of flow marking and flow control rules are as follows:</p> <table><thead><tr><th>rule</th> <th>prefix</th></tr></thead> <tbody><tr><td>traffic marks</td> <td>servicecomb.matchGroup</td></tr> <tr><td>traffic Limiting</td> <td>servicecomb.rateLimiting</td></tr> <tr><td>Circuit Breaker</td> <td>servicecomb.circuitBreaker</td></tr> <tr><td>Bulkhead</td> <td>servicecomb.bulkhead</td></tr> <tr><td>Retry</td> <td>servicecomb.retry</td></tr> <tr><td>Error Injection</td> <td>servicecomb.faultInjection</td></tr> <tr><td>System Rule</td> <td>servicecomb.system</td></tr> <tr><td>System Adaptive</td> <td>servicecomb.system</td></tr></tbody></table> <p>For example, the key of traffic marks must be prefixed with <code>servicecomb.matchGroup</code>. The traffic limiting rule is
prefixed with <code>servicecomb.rateLimiting</code>. The following is an example:</p> <blockquote><p>The traffic marking configuration key：<code>servicecomb.matchGroup.flow</code></p> <p>The key for configuring the traffic limiting rule：<code>servicecomb.rateLimiting.flow</code></p> <p>In the preceding information, <code>flow</code>is the service scenario name. The traffic limiting rule takes effect only when the two service scenario names are the same and the request matches a traffic flag.</p></blockquote> <p>The following describes the related configurations:</p> <ul><li><p><strong>Traffic Marking</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">matches</span><span class="token punctuation">:</span>            <span class="token comment"># Matcher set. Multiple matchers can be configured.</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>          <span class="token comment"># Matched API path. Various comparison modes are supported, such as exact and contain.</span>
    <span class="token key atrule">exact</span><span class="token punctuation">:</span> /degrade <span class="token comment"># Specific Matching Path</span>
  <span class="token key atrule">headers</span><span class="token punctuation">:</span>          <span class="token comment"># Request header</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> 
      <span class="token key atrule">exact</span><span class="token punctuation">:</span> value  <span class="token comment"># Request header value. The value is key=value. The comparison method is the same as that of apiPath.</span>
  <span class="token key atrule">method</span><span class="token punctuation">:</span>           <span class="token comment"># Supported Method Types</span>
  <span class="token punctuation">-</span> GET
  <span class="token key atrule">name</span><span class="token punctuation">:</span> degrade     <span class="token comment"># Configuration name, which is optional.</span>
</code></pre></div><p><strong>what traffic marking above can match  :</strong></p> <ul><li>If the request path is <code>/degrade</code>, the method type is <code>GET</code>, and the request header contains <code>key=value</code>, the matching is successful.</li></ul> <blockquote><p>For details about the configuration items, see the traffic marking section in the <a href="http://servicecomb.gitee.io/servicecomb-java-chassis-doc/java-chassis/zh_CN/references-handlers/governance.html#_2" target="_blank" rel="noopener noreferrer">ServiceComb development document<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></blockquote> <p><strong>Traffic marking request path (apiPath) configuration description</strong></p> <p>The request path for traffic marking varies according to the request protocol configuration. Currently, HTTP (Spring) and RPC (Dubbo) protocols are used. The following describes how to configure the two request protocols:</p> <ul><li><p><strong>Http protocol</strong></p> <p>This protocol performs matching based on the request path. For example, if the request path is <code>localhost:8080/test/flow</code>, the actual path is <code>/test/flow</code>. Therefore, if you need to set a matching rule, you need to configure the matching rule based on the path.</p> <p>It should be noted that if the contextPath configured by the user is valid only after the contextPath prefix is added.</p></li> <li><p><strong>Rpc protocol(Dubbo)</strong></p> <p>The protocol invoking needs to be based on an interface+method. For example, if the requested interface is <code>com.demo.test</code>, and the method is <code>flow</code>, a corresponding request path is <code>com.demo.test.flow</code>. Specially, if a user configures an interface version, for example, a specified version is <code>1.0.0</code>, The request path is <code>com.demo.test:1.0.0.flow</code>. In addition, set the request method to <code>POST</code>. The RPC protocol supports only POST.</p></li></ul></li> <li><p><strong>Traffic Limiting</strong></p> <table><thead><tr><th>Configuration</th> <th>Description</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>limitRefreshPeriod</td> <td>Unit of statistics time, in milliseconds. If you need to set this parameter, the unit can be set to <code>S</code>, for example, <code>10s</code>.</td> <td>1000ms</td> <td>false</td></tr> <tr><td>rate</td> <td>Number of requests that can be processed in the unit of statistical time.</td> <td>1000</td> <td>false</td></tr></tbody></table></li> <li><p><strong>Circuit Breaker</strong></p> <table><thead><tr><th>Configuration</th> <th>Description</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>failureRateThreshold</td> <td>Error rate required for fuse</td> <td>50</td> <td>false</td></tr> <tr><td>minimumNumberOfCalls</td> <td>Minimum number of requests in the sliding window. The fuse condition is determined only when the minimum number of requests is exceeded.</td> <td>100</td> <td>false</td></tr> <tr><td>name</td> <td>Specifies the name of a configuration item. This parameter is optional.</td> <td>null</td> <td>false</td></tr> <tr><td>slidingWindowSize</td> <td>Size of the sliding statistics window. The value can be milliseconds or seconds. For example, 1000 indicates 1000 milliseconds, and 10s indicates 10 seconds.</td> <td>100ms</td> <td>false</td></tr> <tr><td>slidingWindowType</td> <td>Sliding window type. Currently, <code>time</code> and <code>count</code> are supported. The former is based on the time window and the latter is based on the number of requests.</td> <td>time</td> <td>false</td></tr> <tr><td>slowCallDurationThreshold</td> <td>Slow request threshold. The unit is the same as that of the sliding window.</td> <td>60s</td> <td>false</td></tr> <tr><td>slowCallRateThreshold</td> <td>Percentage of slow invoking requests. When the number of slow invoking requests reaches this percentage, connectivity is triggered.</td> <td>100</td> <td>false</td></tr> <tr><td>waitDurationInOpenState</td> <td>Recovery time after a circuit breaker. The default value is <code>60s</code>.</td> <td>60s</td> <td>false</td></tr></tbody></table></li> <li><p><strong>Bulkhead</strong></p> <table><thead><tr><th>Configuration</th> <th>Description</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>maxConcurrentCalls</td> <td>Maximum number of concurrent calls</td> <td>1000</td> <td>false</td></tr> <tr><td>maxWaitDuration</td> <td>Maximum waiting time. If the thread exceeds maxConcurrentCalls, the thread attempts to wait. If the thread does not obtain resources after the waiting time expires, an isolation warehouse exception is thrown.</td> <td>0</td> <td>false</td></tr> <tr><td>name</td> <td>name of configuration, which is optional.</td> <td>null</td> <td>false</td></tr></tbody></table></li> <li><p><strong>Retry</strong></p> <table><thead><tr><th>Configuration</th> <th>Description</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>waitDuration</td> <td>Retry wait time. The default value is milliseconds. The unit is second, for example, 2s.</td> <td>10ms</td> <td>false</td></tr> <tr><td>retryStrategy</td> <td>Retry policy. Currently, two retry policies are supported: fixed interval (FixedInterval) and exponential increase interval (RandomBackoff).</td> <td>FixedInterval</td> <td>false</td></tr> <tr><td>maxAttempts</td> <td>Maximum number of retries</td> <td>3</td> <td>false</td></tr> <tr><td>retryOnResponseStatus</td> <td>HTTP status code. Currently, only HTTP requests are supported. For dubbo requests, you can configure the exception type to determine whether to retry. The default value is RpcException.</td> <td>null</td> <td>false</td></tr></tbody></table></li> <li><p><strong>Error Injection</strong></p> <table><thead><tr><th>Configuration</th> <th>Description</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>type</td> <td>Error injection type. Currently, <code>abort (request response)</code> and <code>delay (request delay)</code> are supported.</td> <td>delay</td> <td>false</td></tr> <tr><td>percentage</td> <td>Error Injection triggering probability</td> <td>-1</td> <td>true</td></tr> <tr><td>fallbackType</td> <td>Return type of the request invoking. This parameter is valid only when <code>type is set to abort</code>. Currently, two types are supported, <code>ReturnNull</code>: empty content is directly returned and the status code is 200. <code>ThrowException</code>: The error code is returned based on the specified error code.`</td> <td>ThrowException</td> <td>false</td></tr> <tr><td>errorCode</td> <td>Specifies the returned error code. The default value is 500. This parameter is valid only <code>when type is abort and fallbackType is ThrowException</code>.</td> <td>500</td> <td>false</td></tr> <tr><td>forceClosed</td> <td>Indicates whether to forcibly disable the error injection capability. If this parameter is set to true, error injection does not take effect. The default value is false.</td> <td>false</td> <td>false</td></tr></tbody></table></li> <li><p><strong>System Rule</strong></p> <table><thead><tr><th>Configuration</th> <th>Configuration</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>systemLoad</td> <td>System load threshold, only supports linux</td> <td>Double.MAX_VALUE</td> <td>false</td></tr> <tr><td>cpuUsage</td> <td>System cpu usage threshold</td> <td>1.0</td> <td>false</td></tr> <tr><td>qps</td> <td>Qps threshold of inlet flow</td> <td>Double.MAX_VALUE</td> <td>false</td></tr> <tr><td>aveRt</td> <td>Average response time threshold of inlet flow, Unit: ms</td> <td>Long.MAX_VALUE</td> <td>false</td></tr> <tr><td>threadNum</td> <td>Number of concurrent threads for the inlet traffic</td> <td>Long.MAX_VALUE</td> <td>false</td></tr></tbody></table></li> <li><p><strong>System Adaptive</strong></p> <table><thead><tr><th>Configuration</th> <th>Configuration</th> <th>Default Value</th> <th>Required</th></tr></thead> <tbody><tr><td>systemLoad</td> <td>System load threshold, only supports linux</td> <td>Double.MAX_VALUE</td> <td>false</td></tr></tbody></table></li></ul> <h3 id="configuring-flow-control-rules-based-on-the-configuration-file"><a href="#configuring-flow-control-rules-based-on-the-configuration-file" class="header-anchor">#</a> Configuring Flow Control Rules Based On The Configuration File</h3> <p>When an application is started, the flow control plugin attempts to read the flow control rules and corresponding traffic flags from the configuration source loaded by SpringBoot. You need to configure the flow control rules before starting the application. The following is a configuration example. The example configuration is based on the <code>application.yml</code> file.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">servicecomb</span><span class="token punctuation">:</span>
  <span class="token key atrule">matchGroup</span><span class="token punctuation">:</span>
    <span class="token key atrule">demo-fault-null</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      matches:
        - apiPath:
            exact: &quot;/flow&quot;</span>
    <span class="token key atrule">demo-retry</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      matches:
        - apiPath:
            prefix: &quot;/retry&quot;
          serviceName: rest-provider
          method:
          - GET</span>
    <span class="token key atrule">demo-rateLimiting</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      matches:
        - apiPath:
            exact: &quot;/flow&quot;</span>
    <span class="token key atrule">demo-circuitBreaker-exception</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      matches:
        - apiPath:
            exact: &quot;/exceptionBreaker&quot;</span>
    <span class="token key atrule">demo-bulkhead</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      matches:
        - apiPath:
            exact: &quot;/flowcontrol/bulkhead&quot;</span>
    <span class="token key atrule">demo-system</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      matched:
        - apiPath:
            prefix: /</span>
  <span class="token key atrule">rateLimiting</span><span class="token punctuation">:</span>
    <span class="token key atrule">demo-rateLimiting</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      rate: 1</span>
  <span class="token key atrule">retry</span><span class="token punctuation">:</span>
    <span class="token key atrule">demo-retry</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      maxAttempts: 3
      retryOnResponseStatus:
      - 500</span>
  <span class="token key atrule">circuitBreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">demo-circuitBreaker-exception</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      failureRateThreshold: 44
      minimumNumberOfCalls: 2
      name: circuit breaker
      slidingWindowSize: 10000
      slidingWindowType: time
      waitDurationInOpenState: 5s</span>
  <span class="token key atrule">bulkhead</span><span class="token punctuation">:</span>
    <span class="token key atrule">demo-bulkhead</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      maxConcurrentCalls: 1
      maxWaitDuration: 10</span>
  <span class="token key atrule">faultInjection</span><span class="token punctuation">:</span>
    <span class="token key atrule">demo-fault-null</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      type: abort
      percentage: 100
      fallbackType: ReturnNull
      forceClosed: false</span>
  <span class="token key atrule">system</span><span class="token punctuation">:</span>
    <span class="token key atrule">demo-system</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      systemLoad: 0.6
      cpuUsage: 0.6
      qps: 100
      aveRt: 20
      threadNum: 100</span>
</code></pre></div><h3 id="publishing-rules-of-dynamic-configuration-capability-based-on-sermant"><a href="#publishing-rules-of-dynamic-configuration-capability-based-on-sermant" class="header-anchor">#</a> Publishing rules of dynamic configuration capability based on Sermant</h3> <p>For details, refer to <a href="/en/document/user-guide/configuration-center.html">Dynamic Configuration User Manual</a></p> <h2 id="supported-versions-and-limitations"><a href="#supported-versions-and-limitations" class="header-anchor">#</a> Supported Versions and Limitations</h2> <h3 id="version-required"><a href="#version-required" class="header-anchor">#</a> Version Required</h3> <table><thead><tr><th>Framework</th> <th>Version</th></tr></thead> <tbody><tr><td>SpringBoot</td> <td>1.2.x - 2.6.x</td></tr> <tr><td>SpringWebMvc</td> <td>4.1.3.RELEASE - 5.3.x</td></tr> <tr><td>Dubbo</td> <td>2.6.x-2.7.x</td></tr></tbody></table> <h3 id="limitations"><a href="#limitations" class="header-anchor">#</a> Limitations</h3> <ul><li>The <code>systemLoad</code> configuration in system rules and system adaptive rules is only limited to <strong>linux</strong></li> <li>The above [Configuring Flow Control Rules Based On The Configuration File](#Configuring Flow Control Rules Based On The Configuration File) is only applicable to <strong>Springboot</strong> applications</li></ul> <h2 id="operation-and-result-validation"><a href="#operation-and-result-validation" class="header-anchor">#</a> Operation and result validation</h2> <p>The following will demonstrate how to use the flow control plugin.</p> <h3 id="preparation"><a href="#preparation" class="header-anchor">#</a> Preparation</h3> <ul><li><a href="https://github.com/sermant-io/Sermant-examples/tree/main/flowcontrol-demo/spring-cloud-demo/spring-provider" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Demo source code</li> <li><a href="https://github.com/sermant-io/Sermant/releases" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or build Sermant package</li> <li><a href="https://zookeeper.apache.org/releases#download" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and start zookeeper</li> <li><a href="https://github.com/vran-dev/PrettyZoo/releases" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> PrettyZoo  and connect zookeeper</li></ul> <h3 id="step-1-compile-and-package-the-demo-application"><a href="#step-1-compile-and-package-the-demo-application" class="header-anchor">#</a> Step 1: Compile and package the demo application</h3> <p>In the <code>${path}/Sermant-examples/flowcontrol-demo/spring-cloud-demo/spring-provider</code> directory execute the following command：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windows,Linux,mac</span>
mvn clean package
</code></pre></div><p>After successful packaging， generate <code>spring-provider.jar</code> int the <code>${path}/Sermant-examples/flowcontrol-demo/spring-cloud-demo/spring-provider/target</code> directory</p> <blockquote><p><strong>Explain</strong>： Path is the path where the demo application is downloaded</p></blockquote> <h3 id="step-2-modify-plug-in-configuration"><a href="#step-2-modify-plug-in-configuration" class="header-anchor">#</a> Step 2: Modify plug-in configuration</h3> <p>Refer to [Plug-in Configuration](#Plugin Configurations) for modification<code>${path}/sermant-agent-x.x.x/agent/pluginPackage/dynamic-config/config/config.yaml</code>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>flow.control.plugin:
  useCseRule: <span class="token boolean">false</span> 
  enable-start-monitor: <span class="token boolean">false</span> 
  enable-system-adaptive: <span class="token boolean">false</span> 
  enable-system-rule: <span class="token boolean">false</span> 
</code></pre></div><h3 id="step-3-start-the-demo-application"><a href="#step-3-start-the-demo-application" class="header-anchor">#</a> Step 3: Start the demo application</h3> <p>Start the demo application with the following command</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windwos</span>
<span class="token function">java</span> -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar <span class="token parameter variable">-Dspring.application.name</span><span class="token operator">=</span>spring-flow-provider <span class="token parameter variable">-Dspring.cloud.zookeeper.connectString</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:2181 <span class="token parameter variable">-jar</span> spring-provider.jar

<span class="token comment">#linux mac</span>
<span class="token function">java</span> -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar <span class="token parameter variable">-Dspring.application.name</span><span class="token operator">=</span>spring-flow-provider <span class="token parameter variable">-Dspring.cloud.zookeeper.connectString</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:2181 <span class="token parameter variable">-jar</span> spring-provider.jar
</code></pre></div><blockquote><p><strong>Explain</strong>：
The ${path} in the above command needs to be replaced with the actual installation path of Sermant。
x.x.x represents a certain version number of Sermant。</p></blockquote> <h3 id="step-4-publish-traffic-tags"><a href="#step-4-publish-traffic-tags" class="header-anchor">#</a> Step 4: Publish traffic tags</h3> <p>Refer to <a href="/en/document/user-guide/configuration-center.html">Dynamic Configuration Center User Manual</a></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;alias: scene\nmatches:\n- apiPath:\n    exact: /flow\n  headers: {}\n  method:\n  - GET\n  name: flow\n&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;group&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service=spring-flow-provider&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;servicecomb.matchGroup.sceneFlow&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Take Zookeeper as an example, use PrettyZoo tool to publish traffic marking strategy and flow control strategy:</p> <ol><li>create node <code>/service=spring-flow-provider</code></li></ol> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <ol start="2"><li>create node <code>/service=spring-flow-provider/servicecomb.matchGroup.sceneFlow</code> and data <code>&quot;alias: scene\nmatches:\n- apiPath:\n exact: /flow\n headers: {}\n method:\n - GET\n name: flow\n&quot;</code></li></ol> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <ol start="3"><li>create node <code>/service=spring-flow-provider/servicecomb.rateLimiting.sceneFlow</code> and data <code>&quot;limitRefreshPeriod: \&quot;2S\&quot;\nname: flow\nrate: \&quot;4\&quot;\n&quot;</code></li></ol> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <h3 id="verify-result"><a href="#verify-result" class="header-anchor">#</a> Verify Result</h3> <p>Request <code>localhost:8003/flow</code> for multiple times. If <code>rate limited</code> is returned when the number of requests exceeds 4 within 2 seconds, flow control is triggered successfully.</p> <div class="el-image"><div class="el-image__placeholder"></div><!----></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/19/2024, 12:17:21 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/en/document/plugin/register-migration.html" class="prev">
        Service Registry
      </a></span> <span class="next"><a href="/en/document/plugin/graceful.html">
        Graceful Startup/Shutdown
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.113d7599.js" defer></script><script src="/assets/js/3.5623409f.js" defer></script><script src="/assets/js/1.b15421ba.js" defer></script><script src="/assets/js/50.e52baf42.js" defer></script><script src="/assets/js/15.e73a6d7c.js" defer></script>
  </body>
</html>
